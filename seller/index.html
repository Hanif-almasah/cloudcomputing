<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Seller | Galeri UMKM</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
    }
    .dashboard-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .dashboard-header h1 {
      font-size: 2rem;
      color: #007bff;
    }
    .product-form {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    .product-form h3 {
      margin-bottom: 1rem;
    }
    .product-form input,
    .product-form select,
    .product-form textarea {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .product-form button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .card-grid {
      display: grid;
      gap: 1.2rem;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .card-body {
      padding: 1rem;
    }
    .card-body h5 {
      margin: 0 0 0.3rem 0;
      font-size: 1.1rem;
    }
    .card-body p {
      margin: 0.2rem 0;
      color: #555;
    }
    .action-buttons {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .delete-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      background-color: #dc3545;
      color: #fff;
    }
    .edit-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      background-color: #ffc107;
      color: #000;
    }
    #previewImg {
      display: none;
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <main class="dashboard-content">
    <div class="dashboard-header">
      <h1>Dashboard Produk Saya</h1>
    </div>

    <div class="product-form">
      <h3>Tambah Produk Baru</h3>
      <input type="text" id="namaProduk" placeholder="Nama Produk" />
      <select id="kategoriProduk">
        <option value="">Pilih Kategori</option>
        <option value="makanan">Makanan & Minuman</option>
        <option value="kerajinan">Kerajinan</option>
        <option value="fashion">Fashion</option>
        <option value="jasa">Jasa</option>
      </select>
      <textarea id="deskripsiProduk" placeholder="Deskripsi Produk"></textarea>
      <input type="number" id="hargaProduk" placeholder="Harga (contoh: 50000)" />
      <input type="file" id="gambarProduk" accept="image/*" />
      <img id="previewImg" />
      <button onclick="tambahProduk()"><i class="fa fa-plus-circle"></i> Tambah Produk</button>
    </div>

    <section class="gallery">
      <div class="card-grid" id="produkList"></div>
    </section>
  </main>

  <!-- Firebase SDK Modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJr6zyzkq-b-XtpeneDig4tEKFdUZ1SB0",
      authDomain: "galeriumkm-af9c7.firebaseapp.com",
      projectId: "galeriumkm-af9c7",
      storageBucket: "galeriumkm-af9c7.appspot.com",
      messagingSenderId: "579650900137",
      appId: "1:579650900137:web:7107247bed6785b4e999b8",
      measurementId: "G-MRYJ0YY6LW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const produkList = document.getElementById('produkList');

    document.getElementById('gambarProduk').addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('previewImg');
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    onSnapshot(collection(db, "products"), (snapshot) => {
      produkList.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-id', docSnap.id);
        card.innerHTML = `
          <img src="${data.image}" alt="Gambar ${data.name}" />
          <div class="card-body">
            <h5>${data.name}</h5>
            <p><strong>Kategori:</strong> ${data.category}</p>
            <p><strong>Deskripsi:</strong> ${data.description}</p>
            <p><strong>Harga:</strong> Rp${parseInt(data.price).toLocaleString()}</p>
            <div class="action-buttons">
              <button class="edit-btn" onclick="editProduk(this)" data-id="${docSnap.id}">Edit</button>
              <button class="delete-btn" onclick="hapusProduk(this)" data-id="${docSnap.id}">Hapus</button>
            </div>
          </div>
        `;
        produkList.appendChild(card);
      });
    });

    window.tambahProduk = async function () {
      const nama = document.getElementById('namaProduk').value.trim();
      const kategori = document.getElementById('kategoriProduk').value.trim();
      const deskripsi = document.getElementById('deskripsiProduk').value.trim();
      const harga = document.getElementById('hargaProduk').value.trim();
      const gambarInput = document.getElementById('gambarProduk');
      const file = gambarInput.files[0];

      if (!nama || !kategori || !deskripsi || !harga || !file) {
        return Swal.fire({
          icon: 'warning',
          title: 'Form belum lengkap',
          text: 'Harap lengkapi semua kolom dan unggah gambar.'
        });
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        const imageBase64 = e.target.result;

        try {
          await addDoc(collection(db, "products"), {
            name: nama,
            category: kategori,
            description: deskripsi,
            price: harga,
            image: imageBase64
          });

          document.getElementById('namaProduk').value = '';
          document.getElementById('kategoriProduk').value = '';
          document.getElementById('deskripsiProduk').value = '';
          document.getElementById('hargaProduk').value = '';
          document.getElementById('gambarProduk').value = '';
          document.getElementById('previewImg').style.display = 'none';

          Swal.fire({
            icon: 'success',
            title: 'Berhasil',
            text: 'Produk berhasil ditambahkan.'
          });
        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Gagal Menyimpan',
            text: err.message
          });
        }
      };
      reader.readAsDataURL(file);
    };

    window.hapusProduk = async function (btn) {
      const docId = btn.getAttribute('data-id');

      const konfirmasi = await Swal.fire({
        title: 'Hapus Produk?',
        text: "Data tidak dapat dikembalikan setelah dihapus.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, hapus',
        cancelButtonText: 'Batal'
      });

      if (!konfirmasi.isConfirmed) return;

      try {
        await deleteDoc(doc(db, "products", docId));
        Swal.fire({
          icon: 'success',
          title: 'Terhapus',
          text: 'Produk berhasil dihapus.'
        });
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Gagal Menghapus',
          text: err.message
        });
      }
    };

    window.editProduk = async function (btn) {
      const docId = btn.getAttribute('data-id');
      const card = btn.closest('.card');
      const name = card.querySelector('h5').innerText;
      const category = card.querySelector('p:nth-of-type(1)').innerText.replace('Kategori: ', '');
      const description = card.querySelector('p:nth-of-type(2)').innerText.replace('Deskripsi: ', '');
      const priceText = card.querySelector('p:nth-of-type(3)').innerText.replace('Harga: Rp', '').replace(/\./g, '');

      const { value: formValues } = await Swal.fire({
        title: 'Edit Produk',
        html:
          `<input id="swal-nama" class="swal2-input" placeholder="Nama Produk" value="${name}">
           <input id="swal-kategori" class="swal2-input" placeholder="Kategori" value="${category}">
           <textarea id="swal-deskripsi" class="swal2-textarea" placeholder="Deskripsi">${description}</textarea>
           <input id="swal-harga" type="number" class="swal2-input" placeholder="Harga" value="${priceText}">`,
        focusConfirm: false,
        preConfirm: () => {
          return {
            name: document.getElementById('swal-nama').value,
            category: document.getElementById('swal-kategori').value,
            description: document.getElementById('swal-deskripsi').value,
            price: document.getElementById('swal-harga').value
          };
        },
        showCancelButton: true,
        confirmButtonText: 'Simpan'
      });

      if (!formValues) return;

      try {
        const docRef = doc(db, "products", docId);
        await updateDoc(docRef, {
          name: formValues.name,
          category: formValues.category,
          description: formValues.description,
          price: formValues.price
        });

        Swal.fire({
          icon: 'success',
          title: 'Berhasil',
          text: 'Produk berhasil diperbarui.'
        });
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Gagal Mengupdate',
          text: err.message
        });
      }
    };
  </script>
</body>
</html>
